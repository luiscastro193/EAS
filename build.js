function e(e){return new Promise((e=>setTimeout(e,1500)))}window.request=async function(e,t){let n=await fetch(e,t);if(n.ok)return n;throw n},window.htmlToElement=function(e){let t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild},window.AuxEvent=class{constructor(){this.event=document.createElement("e"),this.aux=new Event("e")}addListener(e,t){let n=this.event;n.addEventListener("e",(function a(){document.contains(e)?t():n.removeEventListener("e",a)}))}dispatch(){this.event.dispatchEvent(this.aux)}},window.Observable=class{constructor(e){this.variable=e,this.event=new AuxEvent}get value(){return this.variable}set value(e){this.variable=e,this.event.dispatch()}subscribe(e,t){this.event.addListener(e,t)}},window.dataPromise=async function(){let t;for(;!t;)t=await request("data.json").then((e=>e.json())).catch(e);return t}(),window.htmlData={title:document.querySelector("h1").innerText,header:document.querySelector("header").innerHTML,main:document.querySelector("main").innerHTML};let t=new Promise((e=>{document.head.querySelector("[data-id=vegaEmbed]").onload=()=>e()})),n=[];function a(){let e=location.pathname;return e.endsWith("/")?e:e+"/"}const l=dataPromise.then((e=>Object.keys(e.ediciones)));async function i(e,t){let[n,i]=e.split(";");n=`${a()}data/${n}.json`,i=i?i.split(","):[];let o=t?(await l).filter((e=>!t.includes(e))):[];if(!i.some((e=>o.some((t=>e.includes(t))))))return n;let r=await request(n).then((e=>e.text())),s=o.map((e=>`indexof(datum.M, '${e}') == -1`)).join(" && ");return JSON.parse(r.replace("true == true",s))}function o(e){let t=e.split(";")[0].split("/");return t[t.length-1]}function r(e){if(document.body.contains(e[0]))return!0;e[1]()}async function s(e,n){let a=await i(e,n);"string"==typeof a&&(a=await request(a).then((e=>e.json()))),await t;let l=new vega.View(vega.parse(await vegaLite.compile(a).spec),{renderer:"none"}).finalize();return new Blob([await l.toSVG()]).stream()}function c(){alert("Copia el enlace de esta página para guardar la selección")}window.loadChart=async function(e,l,r){let s=await i(l,r);await t;let c=(await vegaEmbed(e,s,{renderer:"canvas",downloadFileName:o(l)})).finalize;r&&function(e,t){let n=`${a()}data/${t.split(";")[0]}.xlsx`,l=htmlToElement(`<a href="${n}" target="_blank" rel="noopener" download>Download table</a>`);e.querySelector(".vega-actions").prepend(l)}(e,l),setTimeout((()=>n.push([e,c])),0)},setInterval((function(){n=n.filter(r)}),1e3),window.share=function(e){e?.preventDefault(),navigator.share?navigator.share({url:location.href}):navigator.clipboard?navigator.clipboard.writeText(location.href).then((()=>alert("Enlace copiado al portapapeles"))).catch(c):c()};const d=import("https://cdn.jsdelivr.net/npm/@zip.js/zip.js/dist/zip.min.js");async function u(e,t){await d;let n=new zip.ZipWriter(new zip.BlobWriter("application/zip"));await Promise.all(e.map((async e=>n.add(e.path,await e.stream))));let a=URL.createObjectURL(await n.close()),l=document.createElement("a");l.href=a,l.download=`${t}.zip`,document.body.append(l),l.click(),URL.revokeObjectURL(a),l.remove()}function h(e){let t=w(e);return[[...y(t,e).values()].map((e=>[...e.values()])).flat().map((e=>[...e.values()])).flat(2),t.m]}let p=!1;let m=!1;async function f(){let e=await dataPromise,t=htmlToElement(`<header class="main-header-container">\n\t\t<a class="home-link" href=" "><i class="fa-solid fa-house"></i></a>\n\t\t<header class="main-header">\n\t\t\t<label for="main-info-checkbox"><h1>${htmlData.title} <span><i class="fa-solid fa-circle-info"></i></span></h1></label>\n\t\t\t<input id="main-info-checkbox" type="checkbox">\n\t\t\t<p class="main-info">${e.infoResultados}</p>\n\t\t</header>\n\t\t<section class="downloads">\n\t\t\t<span><i class="fa-solid fa-download"></i></span>\n\t\t\t<a href="${location.href}">Enlace</a>\n\t\t\t<a role="link">Tablas.zip</a>\n\t\t\t<a role="link">Gráficas.zip</a>\n\t\t</section>\n\t</header>`);t.querySelector(".home-link").onclick=t=>function(e,t){e.preventDefault();let n=w(t);history.pushState(n,""," "),dispatchEvent(new PopStateEvent("popstate",{state:n}))}(t,e);let n=t.querySelectorAll(".downloads > a");return n[0].onclick=share,n[1].onclick=t=>async function(e,t){if(p)return;p=!0,e.target.style.cursor="wait";let n=h(t)[0].map((e=>({path:`${o(e)}.xlsx`,stream:request(`${a()}data/${e.split(";")[0]}.xlsx`).then((e=>e.body))})));await u(n,"Tablas"),e.target.style.cursor="",p=!1}(t,e),n[2].onclick=t=>async function(e,t){if(m)return;m=!0,e.target.style.cursor="wait";let[n,a]=h(t),l=n.map((e=>({path:`${o(e)}.svg`,stream:s(e,a)})));await u(l,"Gráficas"),e.target.style.cursor="",m=!1}(t,e),t}function v(e){return e.estimadores}function w(e){let t=new URLSearchParams(location.hash.substring(1)),n={};for(let[e,a]of t)n[e]=a.split(" ");return function(e,t){let n=v(t);return!!(e.var&&e.est&&e.seg&&e.m&&e.var.length&&e.est.length&&e.seg.length&&e.m.length&&e.var.every((e=>t.variables[e]))&&e.est.every((e=>n[e]))&&e.seg.every((e=>t.segmentaciones[e]))&&e.m.every((e=>t.ediciones[e])))}(n,e)&&n}function b(e,t,n){let a=e.split(";")[1].split(","),l=n.filter((e=>!t.includes(e)));return a.some((e=>!l.some((t=>e.includes(t)))))}function y(e,t){let n=Object.keys(t.ediciones),a=new Map;for(let l of e.var){let i=t.variables[l].archivos,o=new Map;for(let t of e.est){let a=i[t];if(!a)continue;let l=new Map;for(let t of e.seg){let i=a[t];i&&(i=i.filter((t=>b(t,e.m,n))),i.length&&l.set(t,i))}l.size&&o.set(t,l)}o.size&&a.set(l,o)}return a}async function k(){let e=location.hash,t=htmlToElement('<main class="results-page"></main>'),n=await dataPromise;if(e!=location.hash)return t;let a=w(n);if(!a)return location.hash="",t;let l=y(a,n);if(!l.size)return t.append(htmlToElement("<p>Ningún estimador seleccionado está disponible para las variables y ediciones seleccionadas.</p>")),t;let i,o=v(n),r=0;if(a.seg.length>1?r=3:a.est.length>1?r=2:a.var.length>1&&(r=1),r>=1){i=htmlToElement('<h2 class="var-title">Índice de contenidos seleccionados</h2>'),t.append(i);for(let[e,a]of l.entries()){let l=htmlToElement(`<a class="index-link" role="link"><span>${n.variables[e].nombre}</span></a>`);if(l.onclick=()=>t.querySelector(`#var-${e}`).scrollIntoView(),t.append(l),r>=2)for(let[l,i]of a.entries()){let a=htmlToElement(`<a class="index-link indent" role="link"><span>${o[l]}</span></a>`);if(a.onclick=()=>t.querySelector(`#var-${e}-est-${l}`).scrollIntoView(),t.append(a),r>=3)for(let a of i.keys()){let i=htmlToElement(`<a class="index-link indent-2" role="link"><span>${n.segmentaciones[a]}</span></a>`);i.onclick=()=>t.querySelector(`#var-${e}-est-${l}-seg-${a}`).scrollIntoView(),t.append(i)}}}}function s(e){i.scrollIntoView(),e.preventDefault()}function c(){let e=htmlToElement('<a class="index-back"><i class="fa-solid fa-arrow-turn-up"></i></a>');return e.onclick=s,e}function d(e,t,n,a){let l=new URLSearchParams({var:e,est:t,seg:n,m:a.join(" ")});return htmlToElement(`<a class="chart-link" href="${"#?"+l.toString()}" target="_blank"><i class="fa-solid fa-link"></i></a>`)}for(let[e,i]of l.entries()){let l=htmlToElement(`<h2 id="var-${e}" class="var-title">Variable seleccionada: ${n.variables[e].nombre}</h2>`);r>=1&&l.append(c()),t.append(l);for(let[l,s]of i.entries()){let i=htmlToElement(`<label id="var-${e}-est-${l}" for="${e}-${l}" class="est-title"><h2>Estimador seleccionado: ${o[l]} <span><i class="fa-solid fa-circle-info"></i></span></h2></label>`);r>=2&&i.append(c()),t.append(i,htmlToElement(`<input id="${e}-${l}" type="checkbox">`),htmlToElement(`<p>${n.descripciones[l]}</p>`));for(let[i,o]of s.entries()){let s=htmlToElement(`<h2 id="var-${e}-est-${l}-seg-${i}" class="est-title">Segmentación seleccionada: ${n.segmentaciones[i]}</h2>`);r>=3&&s.append(c()),s.append(d(e,l,i,a.m)),t.append(s);for(let e of o){let n=htmlToElement('<div class="chart-container"><div></div></div>');loadChart(n.querySelector("div"),e,a.m),t.append(n)}}}}return t}function g(e,t,n=!1){return n=n?" checked":"",htmlToElement(`<label><input ${t?`name="${t}"`:""} type="checkbox"${n}><span>${e}</span></label>`)}function $(e,t){let n=e.querySelector("input"),a=t.map((e=>e.querySelector("input")));function l(){a.every((e=>e.checked))?n.checked=!0:a.some((e=>!e.checked))&&(n.checked=!1)}n.addEventListener("change",(()=>{for(let e of a)e.checked=n.checked}));for(let e of a)e.addEventListener("change",l);l()}function E(e){return[...new FormData(e).keys()]}function S(e,t,n,a){var l;if(l=e.trim(),""==(e=l.normalize("NFKD").replace(/\p{Diacritic}/gu,"").toLowerCase()))t.querySelectorAll("input").forEach((e=>{e.checked=!1}));else{e=e.split(/\s+/);for(let a of t.children){let t=Array.from(a.querySelectorAll("input")),l=t.shift();l.checked=!1;let i=t.shift();i.checked=!0;for(let a of t){let t=n.variables[a.name].texto;e.every((e=>t.includes(e)))?(a.checked=!0,l.checked=!0):(a.checked=!1,i.checked=!1)}}}a()}function T(e){let t=[...e.querySelectorAll("input")];t.some((e=>e.checked))&&(t[0].checked=!0)}async function q(e){let t=htmlToElement(`<main class="selection-page">${htmlData.main}</main>`),n=0,a=await dataPromise,l=new Set(e?Object.values(e).flat():a.activados),i=t.querySelector("#var-selection");for(let[e,t]of Object.entries(a.bloques)){let o=htmlToElement(`<div>\n\t\t\t<input id="block${++n}-checkbox" type="checkbox">\n\t\t\t<label for="block${n}-checkbox"><span>${e}</span><span><i class="fa-solid fa-play"></i></span></label>\n\t\t</div>`),r=g("Todas"),s=t.map((e=>g(a.variables[e].nombre,e,l.has(e))));$(r,s),o.append(r,...s),T(o),i.append(o)}let o=t.querySelector("#est-selection"),r=g("Todas las tablas"),s=Object.entries(a.estimadores).map((e=>g(e[1],e[0],l.has(e[0]))));$(r,s),o.append(r,...s);let c=t.querySelector("#seg-selection"),d=g("Todas"),u=Object.entries(a.segmentaciones).map((e=>g(e[1],e[0],l.has(e[0]))));$(d,u),c.append(d,...u);let h,p=t.querySelector("#m-selection"),m=g("Todas"),f=Object.entries(a.ediciones).map((e=>g(e[1],e[0],l.has(e[0]))));$(m,f),p.append(m,...f);let v=t.querySelector(".main-button");function w(){h={var:E(i),est:E(o),seg:E(c),m:E(p)},v.disabled=!Object.values(h).every((e=>e.length))}for(let e of t.querySelectorAll("input:not([id])"))e.addEventListener("change",w);v.addEventListener("click",(function(){v.disabled=!0,function(e){let t=new URLSearchParams(Object.entries(e).map((e=>[e[0],e[1].join(" ")])));history.replaceState(e,""),location.hash="?"+t.toString()}(h)})),function(e,t){let n=e.querySelectorAll(".distr-link > span:last-of-type"),a=[t.descripciones.distribution];for(let e=0;e<n.length;e++)n[e].onclick=function(t){t.preventDefault(),alert(a[e])}}(t,a);let b=t.querySelector(".selection-search input");return b.addEventListener("input",(()=>S(b.value,i,a,w))),b.value&&S(b.value,i,a,w),w(),t}let x=0;async function j(e){scrollTo(0,0);const t=x=(x+1)%Number.MAX_SAFE_INTEGER;let n,a,l=location.hash,i=e?.state;l.length>1&&"?"==l[1]?[n,a]=[f(),k()]:[n,a]=[htmlToElement(`<header class="main-header-container main-selection-header">\n\t\t${htmlData.header}\n\t</header>`),q(i)],[n,a]=await Promise.all([n,a]),t==x&&(document.querySelector("header").replaceWith(n),document.querySelector("main").replaceWith(a))}window.onpopstate=j,j();
